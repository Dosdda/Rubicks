<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Rubikâ€™s Cube Timer</title>
<link rel="icon" type="image/png" href="favicon.jpg">

<style>
*{margin:0;padding:0;box-sizing:border-box}

body{
    font-family: -apple-system, BlinkMacSystemFont, "Nunito", sans-serif;
    background:#30364F;
    color:#E1D9BC;
    height:100vh;
    overflow:hidden;
    display:flex;
    padding-left:env(safe-area-inset-left);
    padding-right:env(safe-area-inset-right);
}

.main-container{
    display:flex;
    width:100%;
    height:100%;
}

.start-btn,.stop-btn{
    width:25vw;
    border:none;
    font-size:26px;
    font-weight:700;
    letter-spacing:2px;
    color:#30364F;
}

.start-btn{background:#F0F0DB}
.stop-btn{background:#ACBAC4}

.center-panel{
    flex:1;
    background:rgba(48,54,79,0.95);
    backdrop-filter:blur(20px);
    margin:10px;
    border-radius:30px;
    display:flex;
    flex-direction:column;
    padding:20px;
}

.header{
    text-align:center;
    font-size:16px;
    margin-bottom:10px;
}

.time-display{
    text-align:center;
    font-size:64px;
    margin:10px 0;
    font-variant-numeric:tabular-nums;
}

.status,.stats{
    text-align:center;
    font-size:14px;
    margin-bottom:6px;
    color:#ACBAC4;
}

.lap-section{
    flex:1;
    overflow-y:auto;
    margin-top:10px;
}

.lap-item{
    display:flex;
    justify-content:space-between;
    padding:10px;
    margin-bottom:6px;
    background:rgba(225,217,188,0.15);
    border-radius:10px;
}

.calendar{
    margin-top:10px;
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:4px;
    font-size:11px;
}

.calendar div{
    padding:6px;
    text-align:center;
    border-radius:6px;
    background:rgba(225,217,188,0.1);
}

.calendar .best{
    background:#E1D9BC;
    color:#30364F;
    font-weight:700;
}
</style>
</head>

<body>
<div class="main-container">
    <button class="start-btn">START</button>

    <div class="center-panel">
        <div class="header" id="dateDisplay"></div>

        <div class="time-display" id="timeDisplay">00:00:00.00</div>
        <div class="status" id="statusText">Ready</div>
        <div class="stats" id="statsText">Ao5: -- | Ao12: -- | PB Today: --</div>

        <div class="lap-section">
            <ul id="lapList"></ul>
        </div>

        <div class="calendar" id="calendar"></div>
    </div>

    <button class="stop-btn">STOP</button>
</div>

<script>
class CubeTimer{
    constructor(){
        this.startTime=0;
        this.elapsed=0;
        this.running=false;
        this.ready=false;
        this.history=this.load();
        this.bind();
        this.updateDate();
        this.render();
    }

    bind(){
        document.querySelector('.start-btn').onclick=()=>this.start();
        document.querySelector('.stop-btn').onclick=()=>this.stop();

        document.addEventListener('keydown',e=>{
            if(e.code==='Space'&&!this.running){
                this.ready=true;
                statusText.textContent='Ready';
            }
        });

        document.addEventListener('keyup',e=>{
            if(e.code==='Space'){
                if(this.running)this.stop();
                else if(this.ready)this.start();
                this.ready=false;
            }
        });
    }

    start(){
        this.startTime=Date.now();
        this.running=true;
        statusText.textContent='Running';
        requestAnimationFrame(()=>this.loop());
    }

    stop(){
        if(!this.running)return;
        this.running=false;
        const sec=this.elapsed/1000;
        if(sec<10){
            statusText.textContent='Ignored (<10s)';
            this.elapsed=0;
            return;
        }
        const key=this.today();
        this.history[key]=this.history[key]||[];
        this.history[key].unshift(sec);
        this.save();
        statusText.textContent='Saved';
        this.elapsed=0;
        this.render();
    }

    loop(){
        if(!this.running)return;
        this.elapsed=Date.now()-this.startTime;
        timeDisplay.textContent=this.format(this.elapsed/1000);
        requestAnimationFrame(()=>this.loop());
    }

    format(s){
        const m=Math.floor(s/60);
        const sec=Math.floor(s%60);
        const ms=Math.floor((s*100)%100);
        return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}:${ms.toString().padStart(2,'0')}`;
    }

    today(){
        return new Date().toISOString().split('T')[0];
    }

    average(arr,n){
        if(arr.length<n)return null;
        const slice=arr.slice(0,n).sort((a,b)=>a-b);
        slice.pop();slice.shift();
        return slice.reduce((a,b)=>a+b,0)/slice.length;
    }

    render(){
        const t=this.today();
        const solves=this.history[t]||[];

        statsText.textContent=
            `Ao5: ${this.average(solves,5)?.toFixed(2)||'--'} | `+
            `Ao12: ${this.average(solves,12)?.toFixed(2)||'--'} | `+
            `PB Today: ${solves.length?Math.min(...solves).toFixed(2):'--'}`;

        lapList.innerHTML='';
        solves.slice(0,8).forEach((s,i)=>{
            lapList.innerHTML+=`<li class="lap-item"><span>#${i+1}</span><span>${this.format(s)}</span></li>`;
        });

        this.renderCalendar();
    }

    renderCalendar(){
        calendar.innerHTML='';
        const now=new Date();
        const year=now.getFullYear();
        const month=now.getMonth();
        const days=new Date(year,month+1,0).getDate();

        for(let d=1;d<=days;d++){
            const key=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const div=document.createElement('div');
            div.textContent=d;
            if(this.history[key]){
                div.classList.add('best');
                div.textContent+=` ${Math.min(...this.history[key]).toFixed(1)}`;
            }
            calendar.appendChild(div);
        }
    }

    updateDate(){
        dateDisplay.textContent=new Date().toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'});
        setInterval(()=>this.updateDate(),60000);
    }

    save(){localStorage.setItem('cubeTimer',JSON.stringify(this.history))}
    load(){return JSON.parse(localStorage.getItem('cubeTimer')||'{}')}
}

const timer=new CubeTimer();
</script>
</body>
</html>
